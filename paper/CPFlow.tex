\documentclass[draft, amsfonts, amssymb, aps, nofootinbib, twocolumn]{revtex4-2}
\usepackage[T1]{fontenc}
\usepackage{tgtermes}
\usepackage{amsmath}
\usepackage{empheq}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage[braket, qm]{qcircuit}
\usepackage{braket}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{tikz}
\hypersetup{
	colorlinks   = true, %Colours links instead of ugly boxes
	urlcolor     = blue, %Colour for external hyperlinks
	linkcolor    = blue, %Colour of internal links
	citecolor   = red %Colour of citations
}

\newcommand{\cpflow}{\textit{cpflow }}
\newcommand{\CZ}{$CZ$}
\newcommand{\CX}{$CX$}
\newcommand{\CP}{$CP$}
\newcommand{\T}{$T$}
\newcommand{\tgate}[1]{\textcolor{blue}{#1}}
\newcommand{\cx}[1]{C${}^{#1}$X}
\newcommand{\cz}[1]{C${}^{#1}$Z}
\newcommand{\static}{\textit{\textbf{static}}}
\newcommand{\adaptive}{\textit{\textbf{adaptive}}}
\begin{document}
\title{Variational synthesis of quantum circuits by coherent architecture optimization}
\begin{abstract}
We consider the problem of the variational quantum circuit synthesis into a gate set consisting of 2q \CZ  gate and arbitrary 1q gates with the primary target being minimization of the \CZ-count (or equivalently the CNOT-count). First we note that along with the architecture search, a problem of clear combinatorial origin, optimization over 1q gates can also be a crucial roadblock due to the omnipresence of local minimums (well known in the context of variational quantum algorithms but apparently underappreciated in the context of variational compiling). Taking the issue seriously we make extensive search over the initial conditions an essential part of our approach. 

Another key idea is to use parametrized 2q \CP gate that can interpolate between the identity gate and the \CZ gate and allows to reformulate the discrete architecture search as a continuous optimization problem which can be executed simultaneously with optimization of 1q gate parameters. This coherent optimization of the architecture and 1q gates appears to work surprisingly well in practice, sometimes even outperforming optimization over 1q gates alone (for fixed optimal architecture).

As applications we derive 8-\CX and \T-depth 3 decomposition of the 3q Toffoli gate on the nearest-neighbor topology, rediscover known optimal decompositions of the 4q Toffoli gate on all 4q topologies including a minor 1\CZ-gate improvement on the star-shaped topology, and propose decomposition of the 5q Toffoli gate on the nearest neighbor topology with 48\CZ-gates. We also benchmark performance of our approach on a standard library of 5q quantum circuits showing that in most cases it reliably outperforms existing software. The algorithm developed in this work is available as a python package \cpflow. 
\end{abstract}
\maketitle	
\tableofcontents
\section{Introduction}
The circuit synthesis problem amounts to finding the most efficient circuits optimizing a given loss function. Typical applications include minimizing fidelity with respect to the target unitary (compilation) or maximizing the overlap with the target state (state preparation). Efficiency of the decomposition usually means having the smallest possible number or depth of 2q gates, but other metrics such as the magic gate count are possible. We consider the problem of the variational synthesis into the gate set consisting of a single 2q gate (\CZ or \CX) and arbitrary 1q gates with the primary efficiency goal being minimization of the 2q gate count. It is natural to divide the problem into two parts (i) discrete optimization or architecture search, looking for best placements of 2q gates and (ii) continuous optimization of the 1q gate parameters for a given circuit architecture. The difficulty associated with the architecture search has combinatorial origin and is manifest. The difficulty of the continuous optimization is however also essential as is known in the context of variational quantum optimization but apparently under appreciated in the context of variational compiling.

For small-scale quantum circuits the main hindrance to continuous optimization is the proliferation of local minima. We first show that in many cases of interest the continuous optimization succeeds only for a small fraction of initial conditions. Next, we introduce a new approach to variational compilation. By using parametrized 2q gates the discrete architecture search can be reformulated as a continuous search and performed simultaneously with optimization of 1q gates. This coherent optimization of the architecture and 1q gates appears to work surprisingly well in practice, sometimes even exceeding the efficiently of optimizing 1q gates alone (for a fixed 2q gates architecture). Appreciating the difficulty associated with the local minimums we also make sure to perform extensive scanning thorough the space of initial. We 


Next, we introduce a new approach resting on the two main ideas

We consider the problem of the variational circuit synthesis, seeking to find the most efficient quantum circuits minimizing some loss function, such as fidelity with respect the target unitary in the compilation problem or overlap with the target state in the state preparation problem. Usually the number or depth of 2q gates is the measure 



Variational unitary synthesis seeks to find the best circuit constructions and is useful across a range of tasks such as circuit compilation, quantum simulation, quantum machine learning. 
\begin{itemize}
	\item Compilation -- translate from high-level algorithm to hardware instructions
	\item Relation to hardware efficient variational algorithms
	
\end{itemize}

\begin{align}
d(U,V)=1-\frac1{4^n}|\operatorname{Tr}{U^\dagger V}|^2 \ . \label{d hst}
\end{align}

\begin{align}
\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.8em @!R {
	 & \ctrl{2} & \qw \\
		CZ=\qquad\qquad& &\qquad\qquad\qquad\qquad\quad	= {\begin{pmatrix}1&0&0&0\\0&1&0&0\\0&0&1&0\\0&0&0&-1\end{pmatrix}}		\\
		& \control\qw & \qw \\
		\\ }} \label{def CZ}
	\\
\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.8em @!R { \\
		& \ctrl{2} & \dstick{\hspace{2.0em}\mathrm{P}\,(\mathrm{a})} \qw \\
		CP(a)=\qquad\qquad& &\qquad\qquad\qquad\qquad\qquad\qquad\qquad	= {\begin{pmatrix}1&0&0&0\\0&1&0&0\\0&0&1&0\\0&0&0&e^{i\pi a}\end{pmatrix}}\\
		& \control \qw & \qw\\
		\\ }} \label{def CP}
\end{align}

\subsection{Template circuits}
The prevalent approach in the literature \cite{Khatri2019, Madden2021, Rakyta2021, Nakanishi2021, Rakyta2022} that we will follow is to construct the template circuits out of two-qubit blocks repeated in a regular manner. The two types of entangling blocks we will use are CZ- and CP-blocks depicted at fig.\ref{fig blocks}. They only differ by the type of the entangling gates used. We will explain the choice of 1q gates shortly.
\begin{figure}
\begin{flushleft}
(a)
\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		& \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{a_0})} & \gate{\mathrm{R_Y}\,(\mathrm{a_2})} & \gate{\mathrm{R_Z}\,(\mathrm{a_4})} & \qw & \qw\\
		& \control\qw & \gate{\mathrm{R_X}\,(\mathrm{a_1})} & \gate{\mathrm{R_Y}\,(\mathrm{a_3})} & \gate{\mathrm{R_Z}\,(\mathrm{a_5})} & \qw & \qw\\
		\\ }}\\
(b)
	\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		& \ctrl{1} & \dstick{\hspace{2.0em}\mathrm{P}\,(\mathrm{a_5})} \qw & \qw & \qw & \gate{\mathrm{R_X}\,(\mathrm{a_0})} & \gate{\mathrm{R_Y}\,(\mathrm{a_2})} & \gate{\mathrm{R_Z}\,(\mathrm{a_4})} & \qw & \qw\\
		& \control \qw & \qw & \qw & \qw & \gate{\mathrm{R_X}\,(\mathrm{a_1})} & \gate{\mathrm{R_Y}\,(\mathrm{a_3})} & \gate{\mathrm{R_Z}\,(\mathrm{a_5})} & \qw & \qw\\
		\\ }}
\end{flushleft}
\caption{(a) CZ block (b) CP block.}
\label{fig blocks}
\end{figure}
The blocks are further arranged in sequences we refer to as \textit{layers}. In principle, layers can can be arbitrary, but we will usually identify layers with coupling maps of the target topology. For example see fig.\ref{fig layers} showing layers corresponding the fully connected and chain (or nearest-neighbor) topology.
\begin{figure}
(a)	Connected layer \qquad\qquad(b) Chain layer
\\
\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.8em @!R { \\
		 & \ctrl{1} & \ctrl{2} & \ctrl{3} & \qw & \qw & \qw & \qw \\
		& \control\qw & \qw & \qw & \ctrl{1} & \ctrl{2} & \qw & \qw \\
		& \qw & \control\qw & \qw & \control\qw & \qw & \ctrl{1} & \qw\\
		& \qw & \qw & \control\qw & \qw & \control\qw & \control\qw & \qw \\
		\\ }}\qquad\qquad
\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.8em @!R { \\
		& \ctrl{1} & \qw & \qw & \qw\\
		& \control\qw & \ctrl{1} & \qw & \qw\\
		& \qw & \control\qw & \ctrl{1} & \qw\\
		& \qw & \qw & \control\qw & \qw\\
		\\ }}
\caption{(a) 4q connected layer (b) 4q chain layer. Here CZ gates are only meant to specify locations of 2q blocks, not their content. }
\label{fig layers}
\end{figure}

Finally, to fully specify the template one must provide the total \textit{number of 2q gates}. Layers are repeated until the specified number of 2q gates is reached, the last layer is truncated if needed. We will write $U^k_{CZ}$ or $U^k_{CP}$ for templates with $k$ entangling gates of type \CZ or \CP respectively (layer specification is assumed but left implicit in the notation). For illustration, fig.\ref{fig template example} depicts $U^4_{CZ}$ on a connected topology.

\begin{figure*}
\scalebox{0.65}{
	\Qcircuit @C=1.0em @R=0.2em @!R {
		&&&&&&&&&&&&&&&&&&&&&&&\\
		& \gate{\mathrm{Z}\,(\mathrm{a_{0}})} & \gate{\mathrm{X}\,(\mathrm{a_{1}})} & \gate{\mathrm{Z}\,(\mathrm{a_{2}})} & \ctrl{1} & \gate{\mathrm{X}\,(\mathrm{a_{9}})} & \gate{\mathrm{Y}\,(\mathrm{a_{11}})} & \gate{\mathrm{Z}\,(\mathrm{a_{13}})} & \ctrl{2} & \gate{\mathrm{X}\,(\mathrm{a_{15}})} & \gate{\mathrm{Y}\,(\mathrm{a_{17}})} & \gate{\mathrm{Z}\,(\mathrm{a_{19}})} & \qw & \qw & \qw & \qw & \qw & \qw &\ctrl{1} & \gate{\mathrm{X}\,(\mathrm{a_{27}})} & \gate{\mathrm{Y}\,(\mathrm{a_{29}})} & \gate{\mathrm{Z}\,(\mathrm{a_{31}})} & \qw & \qw\\
		& \gate{\mathrm{Z}\,(\mathrm{a_{3}})} & \gate{\mathrm{X}\,(\mathrm{a_{4}})} & \gate{\mathrm{Z}\,(\mathrm{a_{5}})} & \control\qw & \gate{\mathrm{X}\,(\mathrm{a_{10}})} & \gate{\mathrm{Y}\,(\mathrm{a_{12}})} & \gate{\mathrm{Z}\,(\mathrm{a_{14}})} & \qw & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{X}\,(\mathrm{a_{21}})} & \gate{\mathrm{Y}\,(\mathrm{a_{23}})} & \gate{\mathrm{Z}\,(\mathrm{a_{25}})} & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{a_{28}})} & \gate{\mathrm{Y}\,(\mathrm{a_{30}})} & \gate{\mathrm{Z}\,(\mathrm{a_{32}})} & \qw & \qw\\
		& \gate{\mathrm{Z}\,(\mathrm{a_{6}})} & \gate{\mathrm{X}\,(\mathrm{a_{7}})} & \gate{\mathrm{Z}\,(\mathrm{a_{8}})} & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{a_{16}})} & \gate{\mathrm{Y}\,(\mathrm{a_{18}})} & \gate{\mathrm{Z}\,(\mathrm{a_{20}})} & \control\qw & \gate{\mathrm{X}\,(\mathrm{a_{22}})} & \gate{\mathrm{Y}\,(\mathrm{a_{24}})} & \gate{\mathrm{Z}\,(\mathrm{a_{26}})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw
		\gategroup{1}{5}{5}{17}{1.em}{-}
		\gategroup{1}{19}{5}{23}{1.em}{--}\\
		&&&&&&&&&&&&&&&&&&&&&&&
}}	
\caption{Template circuit $U^4_{CZ}$ on a connected 3q topology with 4 entangling \CZ-blocks. The complete connected layer is boxed, the incomplete layer is dash-boxed.}
\label{fig template example}
\end{figure*}

\subsection{Theoretical lower bound \ref{sec tlb}}
There is a provable minimum amount of \CZ gates required to decompose any $n$-qubit unitary \cite{Shende2004} that we will refer to as the \textit{theoretical lower bound}
\begin{align}
TLB(n) = \frac14\left(4^n-3n-1\right) \ . \label{TLB}
\end{align}
It essentially follows from the simple parameter counting argument. We will sketch the argument which is not only instructive but also helps us to motive the ansatz structure for the template circuits. A unitary matrix on $n$ qubits has in general $4^n$ real parameters. An arbitrary 1q gate on the other hand has 3 real parameters, e.g. angles in the Euler decomposition. Thus, without 2q gates a quantum circuit with $n$ qubits can have no more that $3n$ real parameters. Our template circuits start with a round of 1q gate, cf fig.\eqref{fig template example}. Now, adding a single \CZ gate allows to add two more single qubits gates that do not combine with the existing ones. However, one parameter in each of the single qubit blocks is redundant as illustrated at fig.\ref{fig ZXZ}. Using ZXZ decomposition of an arbitrary single-qubit block $U$ and the fact that $R_Z$ commutes with the the \CZ-gate the leftmost $R_Z$ blocks on each qubit can be pulled to the left and joined with the existing 1q blocks. Therefore adding a single entangling \CZ-block allows to add four more real parameters to the circuit. Requiring that $4TLB(n)+3n=4^{n}-1$ leads to \eqref{TLB} (additional unit subtracted is the irrelevant global phase parameter).

\begin{figure}
\begin{align*}
\scalebox{0.85}{
\Qcircuit @C=0.5em @R=0.4em @!R {
	& \ctrl{1} & \gate{\mathrm{U}} & \qw & \qw\\
	& \control\qw & \gate{\mathrm{U}} & \qw & \qw\\
} 
\quad\raisebox{-1.em}{=}\quad
\Qcircuit @C=0.5em @R=0.4em @!R {	
	& \ctrl{1} & \gate{R_Z} & \qw& \gate{R_X} & \qw& \gate{R_Z} & \qw  & \qw\\
	& \control\qw & \gate{R_Z} & \qw& \gate{R_X} & \qw& \gate{R_Z} & \qw & \qw\\
}
\quad\raisebox{-1.em}{=}\quad
\Qcircuit @C=0.5em @R=0.4em @!R {	
	& \gate{R_Z} & \qw& \ctrl{1} & \gate{R_X} & \qw& \gate{R_Z} & \qw  & \qw\\
	& \gate{R_Z} & \qw& \control\qw & \gate{R_X} & \qw& \gate{R_Z} & \qw & \qw \\
}}
\end{align*}
\caption{Entangling \CZ-block only allows to add four real parameters to the circuit. Explicit gate angles are not depicted.}
\label{fig ZXZ}
\end{figure}

While \eqref{TLB} is a simple theoretical bound, there is strong evidence for its tightness. First of all, there is an constructive analytic procedure, known as the quantum Shannon decomposition \cite{Shende2006}, which produces decomposition of any given unitary using lying only a factor $\frac{23}{12}TLB(n)$ away from the theoretical lower bound. Second, recent studies involving numerical experiments \cite{Madden2021, Rakyta2021} imply that the $\approx2x$ overhead of the quantum Shannon decomposition is not necessary and that \CZ count given by \eqref{TLB} is sufficient to compile random unitaries with a great numerical accuracy.

So far our discussion and the bound \eqref{TLB} addressed generic or random unitaries. However, the unitary matrices of the central importance to quantum computation are highly structured and typically require much less 2q gates. The quantum Shannon decomposition does not appear to be particularly useful in this case. It's extension to not fully-connected topologies is also difficult, often leading to an large multiplicative overhead \cite{Shende2006}. Note that being able to find truly optimal decompositions would amount to determining the gate complexity of a unitary matrix which is an $NP$-complete problem \cite{Botea2018}.

It is therefore a natural idea to use numeric optimization and heuristic methods in the search of efficient decompositions. This strategy is known as the variational compiling and have been explored in a range of works \cite{}. In the next section we review the variational compiling and associated challenges.

\section{Variational synthesis and its challenges}

\begin{figure*}
	\includegraphics[width=0.4\textwidth]{figures/3q_success_chart}
	\includegraphics[width=0.4\textwidth]{figures/4q_success_chart}
	\caption{Local minimums as a function of circuit complexity. Datapoints for random unitaries are advanced by a half unit along $x$ axis for clarity.}
	\label{fig local minumums}
\end{figure*}

Decomposition into 2q and 1q gates implies that two problems need to be solved:
\begin{itemize}
	\item Discrete optimization problem or architecture search, concerned with finding optimal placements for 2q gates.
	\item Continuous optimization problem of finding suitable parameters of 1q gates for a given architecture.
\end{itemize}
While the difficulty of the architecture search has a combinatorial origin and hardly needs explaining, the difficulty of continuous optimization also can not be ignored. Mathematically the problem of variational synthesis is very similar to the classical optimization loop in quantum variational algorithms \cite{}, especially their hardware-efficient \cite{Kandala2017} and adaptive \cite{} forms . Here, the two key obstacles are the \textit{barren plateaus} and \textit{local minimums}. The barren plateaus manifest as vanishing gradients and are usually associated with large number of qubits or parameters. In our experiments with small-scale quantum circuits we did not find it to be relevant. On the other hand, the problem of local minimums alone is sufficient to render training of the variational algorithms $NP$-hard \cite{Bittel2021} in the worst case. As our numerical experiments suggest, local minimums constitute a real hindrance to the variational compiling.

We will quantify the challenges associated with local minimums by the empirical success ratio
\begin{align}
	SR=\frac{M}{N} \ ,
\end{align}
where $N$ is the total number of times the optimization procedure is performed starting with different random initial conditions and $M$ is the number of times a global minimum is reached. 

For example, let $U(a)$ be the unitary matrix of the template circuit from fig.\ref{fig template example} and $a^*$ be some particular choice of angles. It is clear that the global minimum of the Hilbert-Schmidt distance $D(U(a), U(a^*))$ is zero, but gradient-based optimization does not always reach it. With some particular random choice of $a^*$ and random uniform initialization of the template angles our default optimization (detailed in \ref{}) yields success ratio $SR\approx0.3$, which implies that roughly two third of the times the optimization gets stuck in a local minimum. 

We now extend this simple numerical experiment more systematically. Fig.\ref{fig local minumums} charts the success ratios for 3q and 4q circuits as a function of the number of gates. The basic procedure is the same with several additions. First, we used templates with fully connected layers (see fig.\ref{fig layers}) extended to the required number of 2q gates. For each number of 2q gates we take 10 different random parameter assignments $a^*$ and compute success ratios for each of them using 1000 initial conditions, generated uniformly at random. Blue markers represent mean success ratios averaged over 10 target circuits, while error bars quantify the mean standard deviation. Absence of blue markers implies that the empirical success ratio turned out vanishing, i.e. that the global minimum was not reached. For 4q circuits datapoints were only collected for every third gate count.

There are several remarkable features of the graph. First, the success ratio drops very quickly as the 2q gate count increases, reaching values below $10^{-3}$ at 10 \CZ gates for 3q circuits and 15 \CZ gates fro 4q circuits. Next, perhaps surprisingly, the success ratio rises back to values of order 1 as the number of \CZ gates approaches the theoretical lower bound \eqref{TLB}. In fact, this is in agreement with the empirical evidence found in the literature \cite{Madden2021, Rakyta2021, Kiani2020} that near the theoretical lower bound numerical compilation appears to be very efficient. A plausible explanation for this fact \cite{Ge2022} is that when the template is sufficiently expressive, optimization w.r.t. parameters becomes essentially the same as optimization over the unitary matrices themselves. At the same time, cost functions typically considered in quantum computing are simple, often linear or quadratic functions of the unitary matrix elements and hence are not prone to local minimums. Finally, although there is a certain spread of success ratios across different template instances, dependence on the 2q gate count sets the dominating trend.

This suggests that success ratio is mostly determined by the template, not by the target. To confirm this  intuition  we carried out additional experiments using random unitaries $V$ instead of template instances as targets. The difficulty here is that the true value of the global minimum of $D(U(a), V)$ is not known, but the presence of local minimums is still manifest. We modify definition of the success ratio in this case, by counting as successful all optimization runs that approached sufficiently closely the lowest value of $D$ across all runs for a given target unitary. Note that with this modified definition the success ratio can never be zero (because there is always at least a single run with the lowest value). We see that in the regime when success ratios for random instances are sufficiently high success ratios for random unitaries closely parallel them, both in mean and in deviation. In the regions where success ratios for random instances are very small or vanishing, success ratios for random unitaries are non-zero (they can not be by construction) but are sufficiently close to zero. We expect them to drop further if more samples are accounted for. Overall, our experiments strongly suggest that local minimums are mostly determined by the templates and not by targets.

Of course, success ratio is not only a function of the loss landscape but also of the optimization algorithm and the distribution of the initial conditions. There are a number of proposals to alleviate the problem of local minimums by the choice of optimizer \cite{Wierichs2020, Rivera-Dean2021}, but in our experiments none performed sufficiently better than simple ADAM\cite{adam}-based optimization to justify additional computational resources that are typically required by higher-order methods such as the natural gradient \cite{Stokes2020} or imaginary time evolution \cite{Jones2018a}. A recent empirical comparison of various optimization methods for quantum variational algorithms \cite{Lockwood2022} also suggests that the ADAM algorithm can be a simple and efficient choice.

In turn, our own experiments suggest that parametrization and/or distribution of the initial parameters can make a big difference. As explained in \ref{sec tlb} template structure illustrated at fig.\ref{fig template example} features redundant 1q gates. In any entangling block two rotation gates can be removed without compromising circuit expressivity, i.e. without any shrinking in the space of all unitaries obtainable from the template. However, performance of the templates with the minimal number of 1q gates appears to be worse on average (though there are counter examples, see sec.\ref{sec toff4}). This can be due to the fact that overparmetrization favorably deforms the loss landscape and/or because random uniform initialization of the angles produces a different distribution of the initial unitaries. In the present study we do not attempt to disentangle the two possible effects and leave this important question for future work. Unless stated otherwise, reported results correspond to the 'XYZ' templates as per fig.\ref{fig template example}.
\section{The CPFlow algorithm}
\subsection{Motivation and overview}
In the context of variational synthesis results of the previous section suggest that solving the continuous optimization problem may be just as difficult as solving the discrete architecture search: even if the structure of the template is a perfect match for the target unitary, finding the suitable angles may be very challenging. In the absence of an efficient way to solve the latter problem in our approach we choose the brute force route of trying many initial conditions. 
\begin{figure*}
	\scalebox{0.7}{
		\Qcircuit @C=1.0em @R=0.2em @!R { \\
			& \gate{\mathrm{Z}\,(\mathrm{a_{0}})} & \gate{\mathrm{X}\,(\mathrm{a_{1}})} & \gate{\mathrm{Z}\,(\mathrm{a_{2}})} & \ctrl{1} & \dstick{\hspace{2.0em}\mathrm{P}\,(\mathrm{a_{15}})} \qw & \qw & \qw & \gate{\mathrm{X}\,(\mathrm{a_{9}})} & \gate{\mathrm{Y}\,(\mathrm{a_{11}})} & \gate{\mathrm{Z}\,(\mathrm{a_{13}})} & \ctrl{2} & \qw & \qw & \qw & \gate{\mathrm{X}\,(\mathrm{a_{16}})} & \gate{\mathrm{Y}\,(\mathrm{a_{18}})} & \gate{\mathrm{Z}\,(\mathrm{a_{20}})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw\\
			& \gate{\mathrm{Z}\,(\mathrm{a_{3}})} & \gate{\mathrm{X}\,(\mathrm{a_{4}})} & \gate{\mathrm{Z}\,(\mathrm{a_{5}})} & \control \qw & \qw & \qw & \qw & \gate{\mathrm{X}\,(\mathrm{a_{10}})} & \gate{\mathrm{Y}\,(\mathrm{a_{12}})} & \gate{\mathrm{Z}\,(\mathrm{a_{14}})} & \qw & \dstick{\hspace{2.0em}\mathrm{P}\,(\mathrm{a_{22}})} \qw & \qw & \qw & \qw & \qw & \qw & \ctrl{1} & \dstick{\hspace{2.0em}\mathrm{P}\,(\mathrm{a_{29}})} \qw & \qw & \qw & \gate{\mathrm{X}\,(\mathrm{a_{23}})} & \gate{\mathrm{Y}\,(\mathrm{a_{25}})} & \gate{\mathrm{Z}\,(\mathrm{a_{27}})} & \qw & \qw\\
			& \gate{\mathrm{Z}\,(\mathrm{a_{6}})} & \gate{\mathrm{X}\,(\mathrm{a_{7}})} & \gate{\mathrm{Z}\,(\mathrm{a_{8}})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \control \qw & \qw & \qw & \qw & \gate{\mathrm{X}\,(\mathrm{a_{17}})} & \gate{\mathrm{Y}\,(\mathrm{a_{19}})} & \gate{\mathrm{Z}\,(\mathrm{a_{21}})} & \control \qw & \qw & \qw & \qw & \gate{\mathrm{X}\,(\mathrm{a_{24}})} & \gate{\mathrm{Y}\,(\mathrm{a_{26}})} & \gate{\mathrm{Z}\,(\mathrm{a_{28}})} & \qw & \qw\\
			\\ }}
	\caption{ Template 3q circuit $U_{CP}^3$ on a connected topology.}
	\label{fig cp template}
\end{figure*}

A second main idea of our approach is to reformulate the discrete architecture search as a continuous problem as well. \footnote{While this work was in preparation similar idea was independently introduced in \cite{Rakyta2022}.} For illustration, consider the circuit at fig.\ref{fig cp template}. Here 2q gates are the controlled phase gates \eqref{def CP} which interpolate between the identity gate $CP(0)=\mathbb{I}$ and the $CZ$ \eqref{def CZ} gate $CP(\pi)=CZ$. For generic values of the angle $a$ single $CP(a)$ gate can be decomposed into 2 $CZ$ gates (plus 1q gates). Therefore, different values of parameters in $CP$ gates in the template \eqref{fig cp template} effectively capture several different templates with 2q $CZ$ gates and training templates with $CP$-blocks can encompass both the architecture search and the tuning of continuous parameters, moreover performed in a coherent manner.

We can anticipate, however, that training $CP$ templates directly will result in most $CP$ gates having generic angles and hence effectively double the $CZ$ count of the original template. To address this issue we introduce additional \textit{penalty term} to the loss function that is intended to drive all $CP$ angles either to $0$ or to $\pi$. The shape of the penalty function that we use is presented at fig.\ref{fig penalty}.
\begin{figure}
\includegraphics[width=0.3\textwidth]{figures/penalty}
\caption{Penalty function for angles of the \CP-gates. For clarity of the figure, width of plateaus near $0,\frac12\pi, \frac32\pi, 2\pi$ is exaggerated.}
\label{fig penalty}
\end{figure}

This penalty is intended to drive all $CP$-angles during optimization to either $0$ or $\pi$ and hence to reduce the $CZ$-count of the resulting circuit. We chose this simple linear form because linear penalty functions are known to introduce sparcity \cite{} in neural networks, but better choices may be possible. For numerical stability small plateaus are added near values $0,\pi$ and also $\frac12\pi, \frac32\pi$  (empirically we find that $CP$ angles are often equilibrate near these values too).

An obvious problem with this regularization function is the presence of the local minimum at $a=\pi$. In fact, enumerating all local minimums associated to the regularization terms of a \CP-template is equivalent to the discrete search through all \CZ-templates that it can reduce to. Still, our empirical results suggest that simultaneous optimization over \CP and 1q angles is a very efficient strategy if the overall weight of the regularization term is chosen properly. If it is too small, the regularization term has little effect and resulting decompositions tend to have too many \CZ-gates. When the weight is too high, the \CP angles effectively get captures by the closest local minimum and the flexibility of our strategy is lost. In fact, optimization with a high regularization weight could be consider a version of a random search over the architectures (if the initial \CP angles are chosen randomly) and performs significantly worse than optimization with a properly tuned regularization weight.
\subsection{Procedure}
We formulate the general synthesis problem as follows. Let $L(U)$ be the loss function to be minimized with unitary as the argument. For unitary synthesis $L(U)$ may be any measure of fidelity to the target unitary $V$, for example $L(U)=D(U, V)$. For state preparation we can choose $L(U) = \Big|\braket{\psi|U|0}\Big|^2$ where $\ket{\psi}$ is the target state and $\ket{0}$ is the usual reference state, etc. The goal is to find a unitary $U^k_{CZ}(a)$ such that $L(U^k_{CZ}(a))$ is sufficiently close to the global minimum of $L(U)$ and at the same time the number $k$ of 2q gates in $U^k_{CZ}$ is as small as possible. 

The loss function directly addressed by CPFlow is given by
\begin{align}
\mathcal{L}(a)=L(U^k_{CP}(a))+r\sum_{a_i\in CP} R(a_i) \label{CP loss}
\end{align}
The first term is simply the value of the loss function at the given unitary. The second term is the regularization term summing the $CP$-penalties for all $CP$-angles in the circuit. The number of 2q gates $k$ and the overall regularization weight $r$ are two of the most important hyperparameters of the model.

Three main stages of the algorithm are as follows.

\begin{enumerate}
\item \textit{\textbf{ Raw sampling.}} Loss function \eqref{CP loss} is minimized starting from many initial conditions. Both the $CP$-angles and angles of 1q gates are selected uniformly and independently at random\footnote{Distribution of $CP$ angles could be changed.}. 
\item \textit{\textbf{Selecting prospective results.}} Results of the first step are selected based on two criteria (i) the original loss function $L(U^k_{CP}(a^*))$ must be below a given threshold (typically we use $10^{-4}$) and (ii) the number of gates $\sum_{a_i\in CP}G(a_i)$ is below a specified value. Condition (i) means we only accept circuits that are close enough to the global minimum while (ii) filters out decompositions with too high $CZ$ count.
\item \textit{\textbf{Verification.}} Circuits selected at the previous step are first projected from $CP$ to $CZ$ circuits $U_{CP}^k(a)\to U_{CZ}^{k'}(a')$ by rounding off values of $CP$ gates that are sufficiently close to $0$ or $2\pi$ and substituting other $CP$ gates with their 2-CZ decompositions. 1q angles $a'$ are mostly inherited from $a$ except when a decomposition procedure was used. Next, the loss function $L(U_{CZ}^{k'}(a)$ (without the regularization term) is optimized starting from initial angles $a=a'$. The verification is considered successful if the projected $CZ$ circuit reaches a more stringent loss threshold (typically we use $10^{-6}$).
\end{enumerate}

This scheme can be modified in many ways: by choosing a different regularization function, using non-uniform sampling of initial angles, altering details of the gradient based optimizer to name a few. We have mostly experimented with varying two hyperparameters that are evidently crucial, the number of $CP$ gates $k$ and the regularization weight $r$. Heuristically, we find that a reasonable number of $CP$ gates is about twice as much as the expected $CZ$-count of the optimal solution and the value of $r$ for loss functions normalized so that $0\le L(U) \le 1$ is of order $r=5\times 10^{-4}$. To make better choices of hyperparameters on a case by case basis we use Bayesian tuning algorithm provided by Hyperopt package \cite{hyperopt, ?}. Tuning of hyperparameters is significantly hindered by the fact that the loss function is stochastic. Taking sufficiently many samples to reliably estimate the quality of a hyperparameter configuration may cost too much computational resources, while not taking enough the acquired data too noisy to be useful. On the positive side the goal of the algorithm is not to find the best hyperparameters, but rather to find the best decompositions, which can occur (although less likely) for suboptimal hyperparameters as well. The routine including hyperparameter tuning can be summarized as follows.

\begin{enumerate}
\item \textit{\textbf{Defining the search space.}} Choose a distribution to draw $k$ and $r$ from. Typically we use uniform distribution for $k$ in some integer range and lognormal distribution for $r$ with mean around $5\times 10^{-4}$ and standard deviation $0.5$.
\item \textit{\textbf{Evaluating score function.}} Draw a sample $k, r$ from the hyperparmeter distribution according to the Hyperopt algorithm. Execute steps 1 and 2 from the basic routine. Any $CZ$-count is accepted at this stage, i.e. the results are only selected by the value of the original loss function $L(U_{CP}^k(a))$. Let $k_1, k_2,\dots$ be $CZ$ counts of all prospective results selected. We define the score function (reminiscent of the \textit{softmin}) by 
\begin{align}
\text{score}=-\log_2\frac{1}{N}\sum_{i}2^{-k_i}
\end{align}
where $N$ is the total number of raw samples. The minimum of this function is $k_0$, the $CZ$-count of the best possible decomposition. It can be reached if all raw samples reached the threshold fidelity and have the optimal count $k_0$ when projected to $CZ$-circuits. The maximum is $+\infty$ when none of the raw samples passed the fidelity threshold.
\item \textit{\textbf{Verifying best decompositions.}} At the previous stage all prospective decompositions are not verified as the verification process is time-consuming is should not significantly alter the score estimation (some of the decompositions may fail to pass the verification, but this is rare). However, if there are prospective decompositions that improve on the current best they are verified and if accepted, the current best is replaced.

\item \textit{\textbf{Repeat.}} Repeat steps 2 and 3 until either the maximum number of score evaluations is reached or a decomposition with the desired number of gates is found.
\end{enumerate}
\subsection{Technical details}
The \textit{static} routine implemented in \cpflow uses the following default specifications (all could be customized by the user). At the raw sampling stage the optimization of the loss function \eqref{CP loss} is performed using ADAM\cite{} optimizer with learning rate $0.1$ and 2000 iterations. At the selection stage for each sample the best configuration of angles $a^*$ is chosen corresponding to the minimum of the regularized loss function \eqref{CP loss} across all iterations. If the primary loss function $L(U_{CP}^k(a^*))$ is below $10^{-4}$ threshold and the $CP$ circuit is projected to the $CZ$ circuit $U_{CP}^k(a^*)\to U_{CZ}^{k'}(a')$. Projection is performed as follows. $CP$-gates with angles lying withing the threshold distance (0.2 by default) away from $0$ or $\pi$ are replaced by identity and $CZ$ gates respectively.  $CP$-gates that were not replaced at the previous stage are decomposed into 2-$CZ$ decomposition using standard methods. If the 2q gate count $k'$ of the resulting $CZ$-circuit is within the accepted range the circuit is deemed prospective. At the verification stage the original loss function $L(U_{CZ}^{k'}(a))$ is further optimized with the ADAM optimizer, possibly with a smaller learning rate (0.01) and for larger number of iterations (5000). Importantly, the new optimization starts with the initial angles $a'$ obtained after projecting the $CP$ circuit. If the new optimization pass reaches a more stringent threshold ($10^{-6}$ by default) the verification is considered successful and the resulting circuit is added to the collection of decompositions.



\begin{itemize}
	\item Better than random search
	\item Exact synthesis
\end{itemize}
\section{Synthesis of Toffoli gates}
The choice of the Toffoli gates as our key benchmark examples is motivated by several considerations. First, the Toffoli gates are among the most essential building blocks for a great variety of quantum algorithms \cite{}. Next, large multi-controlled Toffoli gates can be built recursively from the smaller ones \ref{}, hence optimization of the small-size Toffoli gates can potentially be propagated to the large multi-controlled gates required in useful quantum algorithms. Lastly, Toffoli gates have been studied extensively \cite{Barenco1995, Song2003, Maslov, Shende2009, Schuch} and although deriving rigorous bounds beyond the 3q case is very difficult, the best existing decompositions are likely to indeed be optimal.

The basic Toffoli gate, also known as the Controlled-Controlled-NOT or the \cx{2} gate is depicted as follows
\begin{align*}
\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		&&&&&\qw&\ctrl{1}&\qw&\qw&\qquad{ }\qquad&& \qw & \ctrl{1} & \qw & \qw \\
		&C{}^{2}X&&\qquad&  =\qquad&\qw&\ctrl{1}&\qw&\qw&\qquad=\qquad&	& \qw & \ctrl{1} & \qw & \qw \\
		&&&&&\qw&\targ&\qw&\qw&\qquad{ }\qquad& & \gate{\mathrm{H}} & \control\qw & \gate{\mathrm{H}} & \qw\\
		\\ }}
\end{align*}
The right diagram represents the Toffoli gate as the \cz{2} gate conjugated by the two Hadamard gates ($HZH=X$). The \cz{2} gate itself is represented by a diagonal matrix \cz{2}$=\operatorname{diag}(1,1,1,1,1,1,1,-1)$ and is symmetric with respect to all qubits. Therefore, up to a conjugation by 1q gates the Toffoli gates (\cx{2} as well as any \cx{n}) are also symmetric. This implies that even if the symmetry between the qubits is broken by e.g. a non-trivial topology, the choice of the target qubit for the Toffoli gate is not relevant for our synthesis problem.


\subsection{3q Toffoli \label{sec toff3}}
\begin{figure*}
	\includegraphics[scale=0.5]{figures/toff3_trials_conn}
	\includegraphics[scale=0.5]{figures/toff3_trials_chain}
	\caption{Visualization of the hyperparameter optimization during \adaptive synthesis of the 3q Toffoli gate on connected (left panel) and chain (right panel) topologies. Red crosses corresponds to infinite score values and imply that no valid decompositions were found at these points. Gold stars mark the best hyperparameter configurations.}
	\label{fig trials}	
\end{figure*}
In this subsection we use \cpflow to find efficient decompositions of the 3q Toffoli gate and illustrate many important features of the algorithm along the way. 3q Toffoli gate can be decomposed into 6 \CZ gates on the fully connected topology or 8 \CZ gates on the chain topology. Using the \cpflow we were able to find many inequivalent decompositions with these optimal \CZ-counts. First, we ran the \adaptive routine with 100 evaluation steps to identify the best hyperparameters in each case. Results are reported at fig.\ref{fig trials}. Best hyperparameters for each topology are shown in tab.\ref{tab toff3}. 

\begin{table}[]
	\begin{tabular}{@{}cccccc@{}}
		\toprule
		& \shortstack[l]{Best number of\\ $\CP$ gates $k$} && \shortstack[l]{Best regularization\\ weight $r$} &  \shortstack[l]{Optimal \\ decompositions} &  \\ \midrule
		Connected & 7      && $1.31\times10^{-3}$ & 28/100                 &  \\
		Chain     & 14     && $0.88\times10^{-3}$ & 19/100                  &  \\ \bottomrule
	\end{tabular}
\caption {Synthesis statistics for the 3q Toffoli gate.}
\label{tab toff3}
\end{table}

Note that at this stage decompositions with the optimal \CZ-counts have already been found, but it is instructive to further analyze the performance of the algorithm and generate more decompositions. To this end we ran the \static routine with optimal hyperparameters and 100 samples for each topology. Third column in tab.\ref{tab toff3} states how many of the initial conditions led to the decompositions with the optimal \CZ-count. For connected and chain topologies respectively, chances of finding optimal decompositions are roughly $30\%$ and $20\%$ respectively. These figures are to be compared with the success ratios at the corresponding gate counts \ref{fig local minumums}, which are of order $10\%$ and $2\%$ respectively. The remarkable conclusion is that (at least in this simple example) our strategy of coherent learning of the architecture together with continuous parameters seems to be unreasonably efficient. With the best hyperparameters, the frequency of finding \CZ-count optimal decompositions is greater than the mean success ratios for reaching the global minimum for fixed architectures.

Decompositions which are initially generated by \cpflow are approximate and many 1q gates bear little resemblance to standard 1q gates such as $H, X, Y, Z, S, T$  which are expressible as rotation gates angles being rational multiples of $\pi$. We develop a simple procedure that tries to eliminate redundant gates, rationalize remaining ones and if possible expand the circuit into Clifford+T gate set. Details of the procedure are deferred to \ref{app exact}. The procedure is heuristic and does not guarantee elimination of all spurious angles, but often works well in practice. Applying it to the decompositions found at the \static stage we are able to generate 12 Clifford+T decompositions of 3q Toffoli gates for each topology. We then sorted these decompositions according to four metrics : \CZ count, \CZ depth, \T count and \T depth. For both topologies decompositions with the smallest \T  depth were simultaneously optimal with respect to the three remaining metrics. Figure fig.\ref{fig toff3} depicts  the best decompositions that were generated. Note that decomposition on the chain layer has \T depth 3 which may be a new result.


\begin{figure*}
\begin{flushleft}
	Connected topology
	\scalebox{0.7}{
	\Qcircuit @C=1.0em @R=0.4em @!R { \\
	& \qw & \qw & \ctrl{1} & \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \qw & \qw & \qw & \ctrl{1} & \qw & \ctrl{2} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\pi})} & \ctrl{2} & \gate{\tgate{\mathrm{Z}\,(\mathrm{\frac{\pi}{4}})}} & \qw & \qw & \qw & \qw & \qw & \qw & \qw\\
	& \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{\pi}{4}})}} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{3\pi}{4}})}} & \control\qw & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{3\pi}{4}})}} & \qw & \qw & \qw & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \gate{\tgate{\mathrm{Z}\,(\mathrm{\frac{\pi}{4}})}} & \qw & \qw\\
	& \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{\pi}{4}})}} & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \control\qw & \gate{\tgate{\mathrm{Z}\,(\mathrm{\frac{\pi}{4}}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw\\
	\\ }}\\
Chain topology
\scalebox{0.65}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		& \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \qw & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \qw & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\pi})} & \gate{\tgate{\mathrm{Z}\,(\mathrm{\frac{5\pi}{4}})}} & \qw & \qw & \qw & \qw & \qw\\
		& \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \control\qw & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{3\pi}{4}})}} & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\tgate{\mathrm{Z}\,(\mathrm{\frac{-3\pi}{4}})}} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \gate{\tgate{\mathrm{Z}\,(\mathrm{\frac{\pi}{4}})}} & \qw & \qw\\
		& \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\pi})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{3\pi}{4}})}} & \qw & \qw & \control\qw & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{3\pi}{4}})}} & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\tgate{\mathrm{X}\,(\mathrm{\frac{3\pi}{4}})}} & \gate{\mathrm{Z}\,(\mathrm{\pi})} & \qw & \qw\\
		\\ }}
\end{flushleft}
\label{fig toff3}
\caption{Decompositions of Toffoli 3 gate that are likely to be optimal with respect to all four metrics: \CZ-depth, \CZ-count, \T-depth, \T-count. Non-Clifford gates are highlighted.}
\end{figure*}


\subsection{4q Toffoli \label{sec toff4}}
\begin{table}[tp]
	\begin{tabular}{@{}cccccc@{}}
		\toprule
		Topology
		&\begin{tikzpicture}[scale=0.5]
		\draw[fill] (0,0) circle [radius=0.1];
		\draw[fill] (0,1) circle [radius=0.1];
		\draw[fill] (1,0) circle [radius=0.1];
		\draw[fill] (1,1) circle [radius=0.1];
		
		\draw (0,0) -- (1, 0) -- (1, 0) -- (1, 1) -- (0, 1) -- (0, 0) -- (1, 1);
		\draw (1, 0) -- (0, 1);
		\end{tikzpicture} 
		&\begin{tikzpicture}[scale=0.5]
		\draw[fill] (0.5,0) circle [radius=0.1];
		\draw[fill] (0.5,0.5) circle [radius=0.1];
		\draw[fill] (0,1) circle [radius=0.1];
		\draw[fill] (1,1) circle [radius=0.1];
		
		\draw (0.5, 0) -- (0.5, 0.5) -- (1, 1) -- (0, 1) -- (0.5, 0.5);
		\end{tikzpicture}
		&\begin{tikzpicture}[scale=0.5]
		\draw[fill] (0,0) circle [radius=0.1];
		\draw[fill] (0,1) circle [radius=0.1];
		\draw[fill] (1,0) circle [radius=0.1];
		\draw[fill] (1,1) circle [radius=0.1];
		
		\draw (0,0) -- (1, 0) -- (1, 1) -- (0, 1) -- (0, 0);
		\end{tikzpicture}  
		&\begin{tikzpicture}[scale=0.5]
		\draw[fill] (0.5,0) circle [radius=0.1];
		\draw[fill] (0.5,0.6) circle [radius=0.1];
		\draw[fill] (0,1) circle [radius=0.1];
		\draw[fill] (1,1) circle [radius=0.1];
		
		\draw (0.5, 0) -- (0.5, 0.6) -- (1, 1);
		\draw (0.5, 0.6) -- (0, 1);
		\end{tikzpicture}    
		& \begin{tikzpicture}[scale=0.5]
		\draw[fill] (0,0) circle [radius=0.1];
		\draw[fill] (0,1) circle [radius=0.1];
		\draw[fill] (1,0) circle [radius=0.1];
		\draw[fill] (1,1) circle [radius=0.1];
		
		\draw (0,1) -- (0, 0) -- (1, 0) -- (1, 1);
		\end{tikzpicture}   \\ \midrule
		CZ count & 14  & 14 & 16 & 16 & 18 \\
		CZ depth & 11  & 13 & 15 & 16 & 14 \\ \bottomrule       
	\end{tabular}
	\caption{Decompositions of 4q Toffoli gate on various topolgies}
	\label{tab toff4}
\end{table}

We now proceed to the decomposition of 4q Toffoli gates which are significantly more challenging. Variational synthesis of the 4q Toffoli gate on various 4q topologies has been recently addressed in \cite{Nakanishi2021}. Remarkably, the approach taken there was that of an exhaustive search over all architectures. It is interesting to note that for exhaustive search connectivity restrictions actually simplify the problem. Using \cpflow we were able to reproduce all results presented in \cite{Nakanishi2021}, see table \ref{tab toff4}. Moreover, for the star-shaped topology we achieved a minor improvement reducing the \CZ count from 17 to 16. The corresponding circuit is depicted at fig.\ref{fig toff4 star}. Note that we did not look for decompositions minimizing \CZ depth, but simply report \CZ depths of the first \CZ count optimal decompositions found during the search.

In all except for the fully connected topology, decompositions were discovered by the \adaptive algorithm with the full range of template depth for 4q unitaries (0, 61), 500 hundred samples at each hyperparameter configuration and 50 hyperparameter evaluations. The clock time in each of those case was less than an hour on our server \ref{server}. Interestingly, the fully connected topology turned out t


\begin{figure*}
\begin{align*}
\scalebox{0.65}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		& \gate{\mathrm{X}\,(\mathrm{\pi})} & \ctrl{1} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \ctrl{2} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{3} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{\frac{-3\pi}{8}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{\pi})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{2} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{X}\,(\mathrm{\frac{3\pi}{8}})} & \qw & \ctrl{3} & \gate{\mathrm{X}\,(\mathrm{\frac{7\pi}{8}})} & \ctrl{2} & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw\\
		& \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{8}})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\pi})} & \gate{\mathrm{X}\,(\mathrm{\frac{5\pi}{8}})} & \control\qw & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw\\
		& \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{\pi})} & \qw & \qw & \qw & \qw & \qw & \control\qw & \qw & \qw & \qw & \qw\\
		& \qw & \qw & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-5\pi}{8}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \qw\\
		\\ }}
\\
\scalebox{0.65}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		& \ctrl{3} & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{8}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{3\pi}{8}})} & \ctrl{3} & \gate{\mathrm{Z}\,(\mathrm{-\pi})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{8}})} & \ctrl{2} & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{3} & \gate{\mathrm{Z}\,(\mathrm{\frac{7\pi}{8}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \ctrl{1} & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{5\pi}{8}})} & \ctrl{3} & \gate{\mathrm{Z}\,(\mathrm{\frac{-\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{Z}\,(\mathrm{\frac{-3\pi}{8}})} & \qw & \qw\\
		& \qw & \qw & \qw & \control\qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{\pi})} & \gate{\mathrm{Z}\,(\mathrm{\frac{-7\pi}{8}})} & \qw & \qw & \qw & \qw & \qw & \qw\\
		& \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{\pi})} & \gate{\mathrm{Z}\,(\mathrm{\frac{-3\pi}{8}})} & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw & \qw\\
		& \control\qw & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw & \qw & \qw & \control\qw & \gate{\mathrm{Z}\,(\mathrm{\frac{-3\pi}{8}})} & \gate{\mathrm{X}\,(\mathrm{\frac{\pi}{2}})} & \gate{\mathrm{Z}\,(\mathrm{\frac{\pi}{2}})} & \qw & \qw\\
		\\ }}
\end{align*}	
\caption{Decomposition of the 4q Toffoli gate on the star topology with 16 \CZ-gates}
\label{fig toff4 star}
\end{figure*}
\subsection{Toffoli 5}
To the best of our knowledge, the best decomposition of \cx{4} on a fully connected topology features $30$ \CZ gates, an upper bound valid for all diagonal gates \cite{Shende2006}. The best result of direct synthesis with \cpflow we observed featured 36 \CZ gates indicating 5q unitaries are significantly harder to address. However, synthesis with topological restrictions is not easily addressed in the analytic framework of \cite{Shende2006} and it is interesting to see if our numerical routine can be useful. First, for a reference point we take qiskit result (60 gates, but what if we start from optimal amount 30 instead of 36?).


\begin{figure}
	\scalebox{1.0}{
	\Qcircuit @C=1.0em @R=0.2em @!R { \\
		\qquad& \ctrl{1} & \qw & \ctrl{1} & \qw & \ctrl{1} & \qw & \qw\\
		\qquad& \ctrl{1} & \qw & \ctrl{1} & \qw & \ctrl{1} & \qw & \qw\\
		C^{4}X=\qquad\qquad& \ctrl{1} & \qw & \ctrl{1} & \qw & \ctrl{2} & \qw & \qw\\
		\qquad& \targ & \ctrl{1} & \targ & \ctrl{1} & \qw & \qw & \qw\\
		\qquad& \qw & \gate{\mathrm{\sqrt{X}^\dagger}} & \qw & \gate{\mathrm{\sqrt{X}}} & \gate{\mathrm{\sqrt{X}}} & \qw & \qw\\
		\\ }}
\caption{A decomposition of Toffoli 5 gate.}
\end{figure}


\section{Benchmarks and results}
\subsection{Clifford+T from database}
\subsection{State prep for error correction}
\section{Synthesis of special gates}
\subsection{Toffoli 3 on chain up to SWAP}
\subsection{Toffoli 4 on all topologies including new record at T-shaped}
\subsection{Toffoli 5 already difficult, can be done separating into parts}

\bibliography{/home/idnm/Dropbox/hep/Sheets/library.bib, bibfile.bib}
\end{document}

\begin{figure}
	
	\centering{\text{Template circuit}}
	
	\scalebox{0.7}{
		\Qcircuit @C=1.0em @R=0.2em @!R { \\
			& \gate{\mathrm{R_Z}\,(\mathrm{a_{0}})} & \gate{\mathrm{R_X}\,(\mathrm{a_{1}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{2}})} & \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{a_{9}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{10}})} & \ctrl{2} & \gate{\mathrm{R_X}\,(\mathrm{a_{13}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{14}})} & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{a_{21}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{22}})} & \qw & \qw\\
			& \gate{\mathrm{R_Z}\,(\mathrm{a_{3}})} & \gate{\mathrm{R_X}\,(\mathrm{a_{4}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{5}})} & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{a_{11}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{12}})} & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{a_{17}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{18}})} & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{a_{23}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{24}})} & \qw & \qw\\
			& \gate{\mathrm{R_Z}\,(\mathrm{a_{6}})} & \gate{\mathrm{R_X}\,(\mathrm{a_{7}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{8}})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{a_{15}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{16}})} & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{a_{19}})} & \gate{\mathrm{R_Z}\,(\mathrm{a_{20}})} & \qw & \qw & \qw & \qw & \qw\\
			\\ }}
	
	\centering{\text{Target circuit}}	
	
	\scalebox{0.7}{
		\Qcircuit @C=1.0em @R=0.2em @!R { \\
			& \gate{\mathrm{R_Z}\,(\mathrm{6.246})} & \gate{\mathrm{R_X}\,(\mathrm{0.5124})} & \gate{\mathrm{R_Z}\,(\mathrm{1.219})} & \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{1.903})} & \gate{\mathrm{R_Z}\,(\mathrm{5.638})} & \ctrl{2} & \gate{\mathrm{R_X}\,(\mathrm{2.711})} & \gate{\mathrm{R_Z}\,(\mathrm{5.384})} & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{1.105})} & \gate{\mathrm{R_Z}\,(\mathrm{1.16})} & \qw & \qw\\
			& \gate{\mathrm{R_Z}\,(\mathrm{4.646})} & \gate{\mathrm{R_X}\,(\mathrm{2.216})} & \gate{\mathrm{R_Z}\,(\mathrm{1.714})} & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{2.833})} & \gate{\mathrm{R_Z}\,(\mathrm{0.6454})} & \qw & \qw & \qw & \ctrl{1} & \gate{\mathrm{R_X}\,(\mathrm{2.812})} & \gate{\mathrm{R_Z}\,(\mathrm{2.779})} & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{2.515})} & \gate{\mathrm{R_Z}\,(\mathrm{2.283})} & \qw & \qw\\
			& \gate{\mathrm{R_Z}\,(\mathrm{6.106})} & \gate{\mathrm{R_X}\,(\mathrm{2.695})} & \gate{\mathrm{R_Z}\,(\mathrm{1.408})} & \qw & \qw & \qw & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{5.926})} & \gate{\mathrm{R_Z}\,(\mathrm{0.1336})} & \control\qw & \gate{\mathrm{R_X}\,(\mathrm{3.677})} & \gate{\mathrm{R_Z}\,(\mathrm{1.53})} & \qw & \qw & \qw & \qw & \qw\\
			\\ }}
	
	\caption{Exemplary template and target circuits.}	
	\label{fig SR circuits}
\end{figure}